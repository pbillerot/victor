[{"categories":null,"contents":"","permalink":"/help/technique/new-site/","tags":["technique"],"title":"Création d'un site Hugo"},{"categories":null,"contents":"Résumé de l\u0026rsquo;article\nComplément de l\u0026rsquo;article\n","permalink":"/help/technique/deploiement/","tags":["technique"],"title":"Deploiement"},{"categories":null,"contents":"Guide pour l\u0026rsquo;administrateur technique\n  Je vous propose d\u0026rsquo;installer une plateforme complète pour héberger notre application Victor.\nNous utiliserons une VM (Machine Virtuelle) DEBIAN 10 avec le gestionnaire de conteneur Docker installé.\nCe document ne décrit pas l\u0026rsquo;installation d\u0026rsquo;une VM Debian et de Docker.\nPour ma part je loue une VPS Debian 10 Docker chez l\u0026rsquo;hébergeur OVH (1 vCore 2 Go 20 Go 1 domaine.eu pour 46.16 €/an)\nPrérequis du système hôte Système : Debian Buster\n\u0026gt;uname -a Linux vps-7d2d773f 4.19.0-16-cloud-amd64 #1 SMP Debian 4.19.181-1 (2021-03-19) x86_64 GNU/Linux Gestionnaire de conteneur Docker :\n\u0026gt;docker version Client: Docker Engine - Community Version: 20.10.5 API version: 1.41 Go version: go1.13.15 ... Server: Docker Engine - Community Engine: Version: 20.10.5 API version: 1.41 (minimum version 1.12) Go version: go1.13.15 ... \u0026gt;docker-compose version docker-compose version 1.21.0, build unknown docker-py version: 3.4.1 CPython version: 3.7.3 OpenSSL version: OpenSSL 1.1.1d 10 Sep 2019 La plateforme Docker   Notre plateforme sera composée de 4 containers :\n  Caddy Server le frontal web, c\u0026rsquo;est l\u0026rsquo;élément le plus important. Il sera chargé :  de contrôler le trafic http (:80) et https (:443) de renouveller le certificat lié au nom de domaine de gérer les authentifications pour certaines URI de rediriger les flux vers les autres containers en fonction des URI de journaliser les accès et les erreurs   Victor le container qui va administrer et servir les web-applications Hugo  Pour plus de confort, j\u0026rsquo;utilise\n  Portainer pour gérer graphiquement l\u0026rsquo;environnement Docker  Filebrowser pour manipuler les fichiers du répertoire partagé (volshare)  Les 4 containers ont accès à la même ressource de fichiers volshare et les échanges entre Caddy Server et les autres containers se font à travers le réseau privé web. Ces containers ne sont pas accessibles de l\u0026rsquo;extérieur.\nLa configuration de Docker se fait à travers le fichier /volshare/docker/docker-compose.yaml, Caddy Server via /volshare/docker/caddy/caddyfile.conf\nNous allons détailler tout cela ci-aprés.\nVolume partagé /volshare /volshare est le répertoire partagé entre tous les containers.\nIl aura la structure suivante :\n/volshare\r/logs\raccess.log access.0.log ... access.9.log\r/etc\r(les certificats du domaine)\r/bivouac\r(le site web Hugo administré par Victor)\r/filebrowser\rdatabase.db\r/data (le répertoire des données à sauvegarder)\r/store\r(le répertoire des fichiers statiques servi par Caddy)\r/bivouac\rbivouac_content --\u0026gt; ../../bivouac/content (lien symbolique)\r/docker (les fichiers de configuration des containers)\rdocker-compose.yaml\r/caddy\rcaddyfile.conf\r/filebrowser\rfilebrowser.conf\r/victor\rdockerfile\rhugo.yaml\r/bivouac\rdeploy.sh (script de déploiement sur un autre site)\rContainer Filebrowser    Filebrowser est un explorateur de fichiers en ligne.\nNous allons le régler pour explorer le répertoire /volshare du système hôte via l\u0026rsquo;url /fb\n/volshare/docker/docker-compose.yaml filebrowser:image:filebrowser/filebrowser:latestcontainer_name:filebrowserrestart:unless-stoppedvolumes:- /volshare:/srv- /volshare/filebrowser/database.db:/database.db- ./filebrowser/filebrowser.json:/.filebrowser.jsonnetworks:- web/volshare/docker/filebrowser/filebrowser.json { \u0026#34;port\u0026#34;: 80, \u0026#34;baseURL\u0026#34;: \u0026#34;/fb\u0026#34;, \u0026#34;address\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;log\u0026#34;: \u0026#34;stdout\u0026#34;, \u0026#34;database\u0026#34;: \u0026#34;/database.db\u0026#34;, \u0026#34;root\u0026#34;: \u0026#34;/srv\u0026#34;, } /volshare/docker/caddy/caddyfile.conf # filebrowser /fb redir /fb /fb/ reverse_proxy /fb/* filebrowser:80 Container Portainer    Portainer via son interface web permet de visualiser les ressources de la plateforme Docker, les containers, les images, les volumes, le réseau.\n/volshare/docker/docker-compose.yaml portainer:image:portainer/portainer-cecontainer_name:portainercommand:-Hunix:///var/run/docker.sockrestart:unless-stoppedvolumes:- /var/run/docker.sock:/var/run/docker.socknetworks:- web/volshare/docker/caddy/caddyfile.conf # portainer # on supprime le préfix /portainer après le routage redir /portainer /portainer/ route /portainer/* { uri strip_prefix /portainer reverse_proxy portainer:9000 } Container Victor   Ce container va héberger l\u0026rsquo;application Victor libre d\u0026rsquo;utilisation sur Github.\nVictor a été écrit dans le langage Golang.\nÀ noter que les 4 containers et Docker lui-même ont été développés en Golang\n/volshare/docker/docker-compose.yaml victor:build:context:victorimage:victorcontainer_name:victorrestart:unless-stoppeduser:1000:1000volumes:- /volshare:/volshare- ./victor/hugo.yaml:/src/victor/conf/hugo.yamlnetworks:- web/volshare/docker/victor/hugo.yaml # Liste des webapp victor à gérerhugoapp:- name:bivouactitle:\u0026#34;Bivouac Admin\u0026#34;folder:\u0026#34;/volshare/bivouac\u0026#34;baseurl:\u0026#34;/bivouac/\u0026#34;theme:\u0026#34;beedream\u0026#34;themehelp:\u0026#34;https://pbillerot.freeboxos.fr/beedream/\u0026#34;deploy:\u0026#34;/volshare/docker/bivouac/deploy.sh/volshare/docker/caddy/caddyfile.conf # victor # qui va servir les webapp hugo décrites dans hugo.yaml reverse_proxy /* victor:8080 # PROTECTION par mot de passe pour les uri /victor /hugo # user: admin password: admin (qui a été haché par la commande ci-dessous) # docker container exec -it caddy /bin/sh # puis # caddy hash-password [--plaintext \u0026lt;password\u0026gt;] basicauth /victor/* { admin JDJhJDE0JGRKNmt6a3g5L1BlSXRmbmVWV2RXeU9Lc2NlZzFGUnV6eHFyYlVYOUFGc3FmL3NsSS5zRXdt } basicauth /hugo/* { admin JDJhJDE0JGRKNmt6a3g5L1BlSXRmbmVWV2RXeU9Lc2NlZzFGUnV6eHFyYlVYOUFGc3FmL3NsSS5zRXdt } Image Victor Ci-après le script qui permet de construire l\u0026rsquo;image Victor.\nÀ noter que ce container intègre le moteur Hugo et des utilitaires Git SSH et Ftp pour déployer les sites sur des serveurs externes\n/volshare/docker/victor/dockerfile # IMAGE VICTOR# ETAPE COMPILATION# Le GOPATH par défaut de cette image est /go.FROMgolang:alpine as goalpine# Installation de GCC et GITRUN apk add build-base git# Installation de victorWORKDIR/srcRUN git clone https://github.com/pbillerot/victor.gitWORKDIR/src/victor# Build avec CGORUN GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo -o /src/victor/victor# ETAPE GENERATION D\u0026#39;UN IMAGE # avec le projetFROMalpine# Installation de victor...RUN mkdir -p /src/victorcopy --from=goalpine /src/victor /src/victor# Uptade OS + hugo + utilitairesRUN apk add --update nano openssh-client hugo git rsync sshpass lftp# Ajout du user 1000 afin de partager les fichiers avec le user du serveur hôteRUN addgroup -g 1000 -S vigo \u0026amp;\u0026amp; \\  adduser -u 1000 -S vigo -G vigo# Point d\u0026#39;entréeWORKDIR/src/victorENTRYPOINT ./victor# Le port sur lequel notre serveur écouteEXPOSE8080Container Caddy /volshare/docker/docker-compose.yaml Version complète\nÀ seul ce container présente des ports accessible de l\u0026rsquo;extérieur (ports 80 et 443)\nversion:\u0026#34;3.3\u0026#34;services:caddy:# https://hub.docker.com/_/caddy?tab=descriptionimage:caddy:latestcontainer_name:caddyrestart:unless-stoppedports:- \u0026#39;80:80\u0026#39;- \u0026#39;443:443\u0026#39;volumes:- \u0026#39;./caddy/caddyfile.conf:/etc/caddy/Caddyfile\u0026#39;- \u0026#39;/volshare/etc:/data\u0026#39;- \u0026#39;/volshare/data/store:/srv\u0026#39;- \u0026#39;/volshare:/volshare\u0026#39;networks:- webfilebrowser:...portainer:...victor:...volumes:certs:networks:web:driver:bridge/volshare/docker/caddy/caddyfile.conf Version complète\nDans ce fichier on trouvera :\n l'email qui sera utilisé pour demander le certificat SSL du domaine le nom du domaine du site éventuellement la liste de d\u0026rsquo;adresses IP indésirables les répertoires servis par l\u0026rsquo;explorateur web intégré à Caddy Server les fichiers logs et enfin les différents reverse_proxy redirigés vers nos containers (qui ont été détaillés plus haut)  # Configuration du serveur Caddy # https://caddyserver.com/docs/ # GLOBAL option # https://www.ssllabs.com/ssltest/analyze.html?d=mon.domaine.com { email mon.email@gmail.com } # HOST mon.domaine.com # blacklist - sites indésirables @blaklist { remote_ip 94.130.212.180 134.119.20.10 } handle @blaklist { respond \u0026#34;Refused!\u0026#34; 403 } # Serveur de fichiers statiques redir /store /store/ handle_path /store/* { root * /volshare/data/store file_server browse } # Log du trafic (rotation automatique tous les 100 Mo (10 logs) log { output file /volshare/log/access.log format single_field common_log } # filebrowser # ... # portainer # ... # victor # ... Procédure d\u0026rsquo;installation cd /volshare/docker # création/mise à jour des containers avec reconstruction des images docker-compose up -d --build # creation/mise à jour des containers sans reconstruction des images docker-compose up -d # nettoyage des images intermédiaires docker image prune -f Démarrage de Victor   Dans votre navigateur préféré taper l\u0026rsquo;URL :\n https://mon.domaine.fr/victor\npuis renseigner le code utilisateur et son mot de passe que vous avez configuré\net vous devriez avoir l\u0026rsquo;écran d\u0026rsquo;accueil de Victor :\n","permalink":"/help/technique/installation/","tags":["technique"],"title":"Installation"},{"categories":null,"contents":"Résumé de l\u0026rsquo;article\nComplément de l\u0026rsquo;article\ndrwxr-xr-x 2 billerot billerot 4,0K avril 3 19:30 bacasable\rdrwxr-xr-x 2 billerot billerot 4,0K avril 6 19:32 captures\rlrwxrwxrwx 1 billerot billerot 18 avril 9 20:41 CHANGELOG.md -\u0026gt; ../../CHANGELOG.md\rlrwxrwxrwx 1 billerot billerot 39 avril 9 20:45 config.yaml -\u0026gt; ../../../../config/_default/config.yaml\r-rw-r--r-- 1 billerot billerot 100 avril 3 19:30 _index.md\r-rw-r--r-- 1 billerot billerot 3,4K avril 9 18:17 installation.md\rdrwxr-xr-x 2 billerot billerot 4,0K avril 6 15:11 media\r-rw-r--r-- 1 billerot billerot 4,8K avril 8 12:14 menu.md\r-rwxr-xr-x 1 billerot billerot 828 mars 10 18:42 modele.md\r-rw-r--r-- 1 billerot billerot 3,4K avril 3 19:30 personnaliser.md\rlrwxrwxrwx 1 billerot billerot 15 avril 9 20:41 README.md -\u0026gt; ../../README.md\r-rw-r--r-- 1 billerot billerot 627 mars 25 08:29 todo.md\r-rw-r--r-- 1 billerot billerot 1,4K avril 6 15:11 vues.md\r","permalink":"/help/technique/repertoires/","tags":["technique"],"title":"Le site Hugo"}]